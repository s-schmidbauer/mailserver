#  BASIC SETTINGS
fqdn: mail2.schmidbauer.cz
host: mail2
mail_domain: schmidbauer.cz

update: False # patch the system
extra_packages:
  - pftop

host_aliases:
  - www2.schmidbauer.cz
  - stream2.schmidbauer.cz

admins:
  - { name: puffy, pass: "$2b$09$rNEtwCuzLuvyIINfE1Z/EOZpusDJ21iI/RQRYOwBkc6cAJcXg7yOK" , key: "{{ lookup('file', '~/.ssh/id_ecdsa.pub') }}" }

users:
  - { name: stefan, pass: "$2b$09$8dbRJ5mjxoVw1oAqgLR2sujIZKfnuBvZGtwlUJnVIakDsszhzpJgi" }
  - { name: backupuser, pass: "$2b$08$93HkUiogG6LjOtwywLRooeu4d6xLlsLsZymEZrNfIio0eGkScbEGu" }

ipv4: 193.235.207.51
ipv6: 2a03:f80:420:193:235:207:51:1
ipv4_gw: 193.235.207.1
ipv6_gw: 2a03:f80:420::1

backup_location: /home/backupuser
delete_backups_older: 6

#  TECHNICAL SETTINGS
ext_if: vio0
net_speed: 125M # 1 Gbit
net_speed_cap: 100M

pf_max_src_conn: 50
pf_max_src_conn_rate: 25/5
pf_max_src_high_conn_rate: 50/5

pf_all_hosts_ports:
  - 22
  - 80
  - 443

pf_trusted_hosts:
  - 194.228.20.3

pf_trusted_hosts_ports:
  - 22
  - 5666

tls_ciphers: EECDH+AESGCM:EDH+AESGCM # httpd, smtpd, dovecot
tls_ecdhe: P-384,P-256,X25519 # httpd
tls_min_version: TLSv1.2 # dovecot

doas_groups_nopass:
  - wheel
# doas_groups: None

ssh_max_auth_retries: 3
ssh_permit_password_auth: "no"
ssh_permit_root_login: "no"
ssh_permit_challenge_response_auth: "no"
ssh_kex_algos: "curve25519-sha256@libssh.org,ecdh-sha2-nistp521,ecdh-sha2-nistp384,ecdh-sha2-nistp256,diffie-hellman-group-exchange-sha256"
ssh_ciphers: "chacha20-poly1305@openssh.com,aes256-gcm@openssh.com,aes128-gcm@openssh.com,aes256-ctr,aes192-ctr,aes128-ctr"
ssh_macs: "hmac-sha2-512-etm@openssh.com,hmac-sha2-256-etm@openssh.com,umac-128-etm@openssh.com,hmac-sha2-512,hmac-sha2-256,umac-128@openssh.com"

httpd_use_tls: false # Only set to true once the certificate is actually generated!
httpd_use_lets_encrypt: true
httpd_enforce_tls: true # Except for Let's Encrypt that  is
httpd_redirect_default_vhost: true
httpd_redirect_default_vhost_destination: https://cloud.schmidbauer.cz/index.php/apps/rainloop/

sysctl:
  - { name: "net.inet.ip.forwarding",   value: 1 }
  - { name: "net.inet6.ip6.forwarding", value: 1 }
  - { name: "net.inet6.ip6.redirect",   value: 1 }
  - { name: "ddb.panic",                value: 0 }

cronjobs:
   - { name: "install system patches",                special_time: "weekly",   job: "syspatch"  }
   - { name: "install package updates",               special_time: "weekly",   job: "pkg_add -u"  }
   - { name: "refresh mail2 certs with acme-client",  special_time: "weekly",   job: "acme-client {{ fqdn }} && rcctl reload httpd"  }
   - { name: "refresh www2 certs with acme-client",   special_time: "weekly",   job: "acme-client www2.schmidbauer.cz && rcctl reload httpd"  }
   - { name: "refresh stream2 certs with acme-client",special_time: "weekly",   job: "acme-client stream2.schmidbauer.cz && rcctl reload httpd"  }
   - { name: "refresh mail2 ocsp with ocspcheck",     special_time: "daily",    job: "ocspcheck -vN -o /etc/ssl/{{ fqdn }}.der /etc/ssl/{{ fqdn }}.fullchain.pem"  }
   - { name: "refresh www2 ocsp with ocspcheck",      special_time: "daily",    job: "ocspcheck -vN -o /etc/ssl/www2.schmidbauer.cz.der /etc/ssl/www2.schmidbauer.cz.fullchain.pem"  }
   - { name: "refresh stream2 ocsp with ocspcheck",   special_time: "daily",    job: "ocspcheck -vN -o /etc/ssl/stream2.schmidbauer.cz.der /etc/ssl/stream2.schmidbauer.cz.fullchain.pem" }
   - { name: "mail backup",                           special_time: "weekly",   job: "/usr/local/bin/mail_backup.sh"  }


mail_max_size: 50M # used in smtpd and dovecot
smtpd_max_deferred: 1000
smtpd_queue_ttl: 4d
smtpd_warn_interval: 1h, 6h, 2d

smtpd_domains:
  - schmidbauer.cz
  - cloud.schmidbauer.cz
  - mail.schmidbauer.cz
  - man.schmidbauer.cz

smtp_aliases:
   - { name: cloud,                         target: stefan }
   - { name: hello,                         target: stefan }
   - { name: hallo,                         target: stefan }
   - { name: ahoj,                          target: stefan }
   - { name: puff,                          target: stefan }
   - { name: monitoring,                    target: stefan }
   - { name: stefan@schmidbauer.cz,         target: stefan }
   - { name: anna@schmidbauer.cz,           target: anna }
   - { name: max@schmidbauer.cz,            target: max }
   - { name: mattias@schmidbauer.cz,        target: mattias }
   - { name: hans@schmidbauer.cz,           target: hans }
   - { name: angelika@schmidbauer.cz,       target: angelika }
   - { name: chiemseewelle@schmidbauer.cz,  target: chiemseewelle }

smtp_filters:
   # - { name: check_dyndns, command: "phase connect match rdns regex { '.*\.dyn\..*', '.*\.dsl\..*', '.*\.glas\..*' } junk" }
   - { name: check_rdns,    command: "phase connect match !rdns junk" }
   - { name: check_fcrdns,  command: "phase connect match !fcrdns junk" }
   - { name: senderscore,   command: "proc-exec 'filter-senderscore -blockBelow 10 -junkBelow 70 -slowFactor 5000'" }
   - { name: rspamd,        command: "proc-exec 'filter-rspamd'" }

smtp_used_filters:
   # - check_dyndns
   - check_rdns
   - check_fcrdns
   - senderscore
   - rspamd

dovecot_auth_mechanisms: plain
dovecot_auth_failure_delay: 5
dovecot_first_valid_uid: 1000
dovecot_mail_location: maildir:~/Maildir
dovecot_mail_folders:
   - { name: Drafts, special_use: Drafts }
   - { name: Sent, special_use: Sent }
   - { name: Trash, special_use: Trash }
   - { name: Junk, special_use: Junk }
   - { name: Archive, special_use: Archive }

dovecot_masteruser: mailadmin
dovecot_masteruser_pass: "{CRYPT}$2y$05$S40YgQ8ffbcWyy1es.nn1ei9Esoqs561o7Ih3Yzbs0X9ipN1gmxTq"
dovecot_imap_plugins:
  - imap_sieve
  - imap_acl
dovecot_sieve_plugins:
  - sieve_imapsieve
  - sieve_extprograms

sieve_folder: /usr/local/lib/dovecot/sieve

dkim_version: 1
dkim_key_folder: /etc/mail/dkim
dkim_key_algo: rsa
dkim_key_size: 1024
dkim_signing_allow_username_mismatch: true

dmarc_version: 1
dmarc_policy: quarantine
dmarc_percent: 100
dmarc_rua_contact: "hostmaster@{{ mail_domain }}"

spf_version: 1
spf_scope: all

tlsa_usage: "3 1 1"
tlsa_ports: "443 143 25 587 993 465"
